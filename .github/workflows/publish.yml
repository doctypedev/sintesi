name: Publish to NPM

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release Type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  id-token: write
  contents: write
  pull-requests: read

jobs:
  publish:
    name: Publish TS Packages
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.version.outputs.NEW_TAG }}
      should_release: ${{ steps.bump.outputs.type != '' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'

      - name: Detect Release Label & Bump
        id: bump
        uses: actions/github-script@v7
        with:
          script: |
            const detectReleaseType = require('./.github/scripts/detect-release-type.js');
            await detectReleaseType({ github, context, core });

      - name: Version Bump & Push Tag
        id: version
        if: steps.bump.outputs.type
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          npm version ${{ steps.bump.outputs.type }} -m "chore(release): %s"
          git push --follow-tags
          echo "NEW_TAG=$(git describe --abbrev=0)" >> $GITHUB_OUTPUT

      - name: Update npm
        if: steps.bump.outputs.type
        run: npm install -g npm@latest

      - name: Setup Rust
        if: steps.bump.outputs.type
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust core types
        if: steps.bump.outputs.type
        run: |
          cd crates/core
          npm install
          npm run build

      - name: Install dependencies
        if: steps.bump.outputs.type
        run: npm ci

      - name: Run tests
        if: steps.bump.outputs.type
        run: npm test

      - name: Build
        if: steps.bump.outputs.type
        run: npm run build

      - name: Publish to NPM
        if: steps.bump.outputs.type
        run: |
          # TODO: Refine version check by comparing current (publishing) version with latest available
          # to handle edge cases more robustly (e.g., downgrades, prereleases)
          # See: https://github.com/doctypedev/doctype/issues/70
          VERSION=$(node -p "require('./package.json').version")
          PUBLISHED_VERSION=$(npm view @doctypedev/doctype version 2>/dev/null || echo "")

          if [ "$VERSION" = "$PUBLISHED_VERSION" ]; then
            echo "ğŸ“¦ Version $VERSION already published, skipping"
            exit 0
          fi

          echo "ğŸ“¦ Publishing @doctypedev/doctype@$VERSION"

          # Try to publish, but handle "already published" error gracefully
          if ! npm publish --provenance 2>&1 | tee /tmp/publish.log; then
            if grep -q "cannot publish over the previously published versions" /tmp/publish.log; then
              echo "âœ… Version already published (publish succeeded but npm reported it as error)"
              exit 0
            else
              echo "âŒ Publish failed"
              cat /tmp/publish.log
              exit 1
            fi
          fi

          echo "âœ… Published successfully"

  publish-native:
    name: Publish Native Packages (${{ matrix.settings.platform }}-${{ matrix.settings.arch }})
    needs: publish
    runs-on: ${{ matrix.settings.host }}
    if: needs.publish.outputs.should_release == 'true'
    strategy:
      fail-fast: false
      matrix:
        settings:
          # macOS ARM64 (Apple Silicon)
          - host: macos-latest
            target: aarch64-apple-darwin
            platform: darwin
            arch: arm64

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.target }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'

      - name: Pull latest changes (including new tag)
        run: git pull --tags

      - name: Update npm
        run: npm install -g npm@latest

      - name: Install root dependencies
        run: npm ci

      - name: Install napi-rs dependencies
        run: |
          cd crates/core
          npm install

      - name: Check for Rust changes
        id: rust_changes
        run: |
          # Check if there are any changes in Rust code since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "No previous tag found, will build Rust"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            RUST_CHANGES=$(git diff --name-only $LAST_TAG HEAD | grep -E '^crates/core/(src/|Cargo\.)' || true)

            if [ -n "$RUST_CHANGES" ]; then
              echo "Rust changes detected:"
              echo "$RUST_CHANGES"
              echo "has_changes=true" >> $GITHUB_OUTPUT
            else
              echo "No Rust changes detected, will reuse existing binary"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Sync version to native packages
        run: node crates/core/scripts/sync-version.js

      - name: Download previous binary (if no Rust changes)
        if: steps.rust_changes.outputs.has_changes == 'false'
        run: |
          PREV_VERSION=$(npm view @doctypedev/core-${{ matrix.settings.platform }}-${{ matrix.settings.arch }} version 2>/dev/null || echo "")

          if [ -n "$PREV_VERSION" ]; then
            echo "ğŸ“¦ Downloading previous version: $PREV_VERSION"
            npm pack @doctypedev/core-${{ matrix.settings.platform }}-${{ matrix.settings.arch }}@$PREV_VERSION

            # Extract binary from tarball
            tar -xzf *.tgz

            NODE_BINARY_NAME="doctype-core.${{ matrix.settings.platform }}-${{ matrix.settings.arch }}.node"
            NPM_PACKAGE_DIR="crates/core/npm/${{ matrix.settings.platform }}-${{ matrix.settings.arch }}"

            cp "package/$NODE_BINARY_NAME" "$NPM_PACKAGE_DIR/$NODE_BINARY_NAME"
            echo "â™»ï¸  Reused binary from version $PREV_VERSION"

            # Clean up downloaded package to avoid contamination
            echo "ğŸ§¹ Cleaning up downloaded package files..."
            rm -rf package/ *.tgz
          else
            echo "âš ï¸  No previous version found, will build from scratch"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Build with napi-rs (if Rust changed)
        if: steps.rust_changes.outputs.has_changes == 'true'
        run: |
          cd crates/core
          npm run build
        env:
          CARGO_BUILD_TARGET: ${{ matrix.settings.target }}

      - name: Copy binary to npm package (if Rust changed)
        if: steps.rust_changes.outputs.has_changes == 'true'
        run: |
          NODE_BINARY_NAME="doctype-core.${{ matrix.settings.platform }}-${{ matrix.settings.arch }}.node"
          NPM_PACKAGE_DIR="crates/core/npm/${{ matrix.settings.platform }}-${{ matrix.settings.arch }}"

          cp "crates/core/$NODE_BINARY_NAME" "$NPM_PACKAGE_DIR/$NODE_BINARY_NAME"
          echo "âœ… Binary copied to $NPM_PACKAGE_DIR/$NODE_BINARY_NAME"

      - name: List package contents
        run: |
          echo "ğŸ“¦ Package contents:"
          ls -lah crates/core/npm/${{ matrix.settings.platform }}-${{ matrix.settings.arch }}/

      - name: ğŸ” Verify package.json version
        run: |
          cd crates/core/npm/${{ matrix.settings.platform }}-${{ matrix.settings.arch }}
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          echo "============================================"
          echo "ğŸ“‹ About to publish:"
          echo "   Name: $PACKAGE_NAME"
          echo "   Version: $PACKAGE_VERSION"
          echo "============================================"

      - name: Publish to NPM
        run: |
          cd crates/core/npm/${{ matrix.settings.platform }}-${{ matrix.settings.arch }}

          # TODO: Refine version check by comparing current (publishing) version with latest available
          # to handle edge cases more robustly (e.g., downgrades, prereleases)
          # See: https://github.com/doctypedev/doctype/issues/70
          PACKAGE_NAME="@doctypedev/core-${{ matrix.settings.platform }}-${{ matrix.settings.arch }}"
          VERSION=$(node -p "require('./package.json').version")
          PUBLISHED_VERSION=$(npm view $PACKAGE_NAME version 2>/dev/null || echo "")

          if [ "$VERSION" = "$PUBLISHED_VERSION" ]; then
            echo "ğŸ“¦ Version $VERSION already published, skipping"
            exit 0
          fi

          echo "ğŸ“¦ Publishing $PACKAGE_NAME@$VERSION"

          # Try to publish, but handle "already published" error gracefully
          if ! npm publish --provenance 2>&1 | tee /tmp/publish.log; then
            if grep -q "cannot publish over the previously published versions" /tmp/publish.log; then
              echo "âœ… Version already published (publish succeeded but npm reported it as error)"
              exit 0
            else
              echo "âŒ Publish failed"
              cat /tmp/publish.log
              exit 1
            fi
          fi

          echo "âœ… Published successfully"

  create-release:
    name: Create GitHub Release
    needs: [publish, publish-native]
    runs-on: ubuntu-latest
    if: needs.publish.outputs.should_release == 'true'
    steps:
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.publish.outputs.new_tag }}
          generate_release_notes: true
