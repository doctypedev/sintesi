name: Publish to NPM

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release Type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  id-token: write
  contents: write
  pull-requests: read

jobs:
  publish:
    name: Publish TS Packages
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.version.outputs.NEW_TAG }}
      should_release: ${{ steps.bump.outputs.type != '' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'

      - name: Detect Release Label & Bump
        id: bump
        uses: actions/github-script@v7
        with:
          script: |
            const detectReleaseType = require('./.github/scripts/publish/detect-release-type.js');
            await detectReleaseType({ github, context, core });

      - name: Version Bump & Push Tag
        id: version
        if: steps.bump.outputs.type
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          npm version ${{ steps.bump.outputs.type }} -m "chore(release): %s"
          git push --follow-tags
          echo "NEW_TAG=$(git describe --abbrev=0)" >> $GITHUB_OUTPUT

      # Cache node_modules to speed up builds
      - name: Cache node_modules
        if: steps.bump.outputs.type
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Update npm
        if: steps.bump.outputs.type
        run: npm install -g npm@latest

      - name: Setup Rust
        if: steps.bump.outputs.type
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust core types
        if: steps.bump.outputs.type
        run: |
          cd crates/core
          npm install
          npm run build

      - name: Install dependencies
        if: steps.bump.outputs.type
        run: npm ci

      - name: Run tests
        if: steps.bump.outputs.type
        run: npm test

      - name: Build
        if: steps.bump.outputs.type
        run: npm run build

      # Save build artifacts to reuse in publish-native job
      - name: Upload build artifacts
        if: steps.bump.outputs.type
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            dist/
            package.json
            package-lock.json
          retention-days: 1

      # Use composite action for publishing
      - name: Publish to NPM
        if: steps.bump.outputs.type
        uses: ./.github/actions/npm-publish
        with:
          package_dir: '.'

  publish-native:
    name: Publish Native Packages (${{ matrix.settings.platform }}-${{ matrix.settings.arch }})
    needs: publish
    runs-on: ${{ matrix.settings.host }}
    if: needs.publish.outputs.should_release == 'true'
    strategy:
      fail-fast: false
      matrix:
        settings:
          # macOS ARM64 (Apple Silicon)
          - host: macos-latest
            target: aarch64-apple-darwin
            platform: darwin
            arch: arm64

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Pull latest changes (including new tag)
        run: git pull --tags

      # Download build artifacts from previous job instead of rebuilding
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.target }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'

      # Cache Rust dependencies to speed up builds
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            crates/core/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      # Only install napi-rs dependencies (not root project)
      - name: Install napi-rs dependencies
        run: |
          cd crates/core
          npm install

      - name: Check for Rust changes
        id: rust_changes
        run: |
          # Check if there are any changes in Rust code since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "No previous tag found, will build Rust"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            RUST_CHANGES=$(git diff --name-only $LAST_TAG HEAD | grep -E '^crates/core/(src/|Cargo\.)' || true)

            if [ -n "$RUST_CHANGES" ]; then
              echo "Rust changes detected:"
              echo "$RUST_CHANGES"
              echo "has_changes=true" >> $GITHUB_OUTPUT
            else
              echo "No Rust changes detected, will reuse existing binary"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Sync version to native packages
        run: node crates/core/scripts/sync-version.js

      - name: Download previous binary (if no Rust changes)
        if: steps.rust_changes.outputs.has_changes == 'false'
        run: |
          PREV_VERSION=$(npm view @doctypedev/core-${{ matrix.settings.platform }}-${{ matrix.settings.arch }} version 2>/dev/null || echo "")

          if [ -n "$PREV_VERSION" ]; then
            echo "ðŸ“¦ Downloading previous version: $PREV_VERSION"
            npm pack @doctypedev/core-${{ matrix.settings.platform }}-${{ matrix.settings.arch }}@$PREV_VERSION

            # Extract binary from tarball
            tar -xzf *.tgz

            NODE_BINARY_NAME="doctype-core.${{ matrix.settings.platform }}-${{ matrix.settings.arch }}.node"
            NPM_PACKAGE_DIR="crates/core/npm/${{ matrix.settings.platform }}-${{ matrix.settings.arch }}"

            cp "package/$NODE_BINARY_NAME" "$NPM_PACKAGE_DIR/$NODE_BINARY_NAME"
            echo "â™»ï¸  Reused binary from version $PREV_VERSION"

            # Clean up downloaded package to avoid contamination
            echo "ðŸ§¹ Cleaning up downloaded package files..."
            rm -rf package/ *.tgz
          else
            echo "âš ï¸  No previous version found, will build from scratch"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Build with napi-rs (if Rust changed)
        if: steps.rust_changes.outputs.has_changes == 'true'
        run: |
          cd crates/core
          npm run build
        env:
          CARGO_BUILD_TARGET: ${{ matrix.settings.target }}

      - name: Copy binary to npm package (if Rust changed)
        if: steps.rust_changes.outputs.has_changes == 'true'
        run: |
          NODE_BINARY_NAME="doctype-core.${{ matrix.settings.platform }}-${{ matrix.settings.arch }}.node"
          NPM_PACKAGE_DIR="crates/core/npm/${{ matrix.settings.platform }}-${{ matrix.settings.arch }}"

          cp "crates/core/$NODE_BINARY_NAME" "$NPM_PACKAGE_DIR/$NODE_BINARY_NAME"
          echo "âœ… Binary copied to $NPM_PACKAGE_DIR/$NODE_BINARY_NAME"

      - name: List package contents
        run: |
          echo "ðŸ“¦ Package contents:"
          ls -lah crates/core/npm/${{ matrix.settings.platform }}-${{ matrix.settings.arch }}/

      # Use composite action for publishing
      - name: Publish to NPM
        uses: ./.github/actions/npm-publish
        with:
          package_dir: 'crates/core/npm/${{ matrix.settings.platform }}-${{ matrix.settings.arch }}'

  create-release:
    name: Create GitHub Release
    needs: [publish, publish-native]
    runs-on: ubuntu-latest
    if: needs.publish.outputs.should_release == 'true'
    steps:
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.publish.outputs.new_tag }}
          generate_release_notes: true
