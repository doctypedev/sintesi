name: Release

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    outputs:
      published: ${{ steps.changesets.outputs.published }}
      publishedPackages: ${{ steps.changesets.outputs.publishedPackages }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v3
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Setup Rust (for type gen if needed, or just copy)
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust core types
        run: |
          cd crates/core
          pnpm install
          pnpm run build

      # Copy native types from crates/core to packages/core BEFORE build
      - name: Prepare Core Native Types
        run: cp crates/core/index.d.ts packages/core/native-types.d.ts

      - name: Build packages
        run: pnpm run build

      - name: Update npm
        run: npm install -g npm@latest

      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          publish: pnpm run release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # NPM_TOKEN not needed for trusted publishing (OIDC)

  check-native-changes:
    runs-on: ubuntu-latest
    outputs:
      native_changed: ${{ steps.filter.outputs.native }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          # Check changes with the base branch (main)
          base: main
          filters: |
            native:
              - 'crates/**'

  release-native:
    name: Release Native (${{ matrix.settings.platform }}-${{ matrix.settings.arch }})
    needs: [release, check-native-changes]
    if: needs.release.outputs.published == 'true' && needs.check-native-changes.outputs.native_changed == 'true'
    runs-on: ${{ matrix.settings.host }}
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: macos-latest
            target: aarch64-apple-darwin
            platform: darwin
            arch: arm64

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v3
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org/'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.target }}

      - name: Update npm
        run: npm install -g npm@latest

      - name: Pull latest changes
        run: git pull origin main

      - name: Install dependencies
        run: pnpm install

      - name: Sync version to native packages
        run: node crates/core/scripts/sync-version.js

      - name: Build and Publish Native Package
        env:
          CARGO_BUILD_TARGET: ${{ matrix.settings.target }}
        run: |
          # Build Rust binary
          cd crates/core
          pnpm install
          pnpm run build
          
          # Copy binary to npm package location
          NODE_BINARY_NAME="doctype-core.${{ matrix.settings.platform }}-${{ matrix.settings.arch }}.node"
          NPM_PACKAGE_DIR="npm/${{ matrix.settings.platform }}-${{ matrix.settings.arch }}"
          
          # Ensure directory exists
          mkdir -p "$NPM_PACKAGE_DIR"
          
          cp "$NODE_BINARY_NAME" "$NPM_PACKAGE_DIR/$NODE_BINARY_NAME"
          
          # Publish
          cd "$NPM_PACKAGE_DIR"
          echo "ðŸ“¦ Publishing native package from $(pwd)"
          
          # Check if version exists
          PACKAGE_NAME="@doctypedev/core-${{ matrix.settings.platform }}-${{ matrix.settings.arch }}"
          VERSION=$(node -p "require('./package.json').version")
          PUBLISHED_VERSION=$(npm view $PACKAGE_NAME version 2>/dev/null || echo "")

          if [ "$VERSION" = "$PUBLISHED_VERSION" ]; then
            echo "ðŸ“¦ Version $VERSION already published, skipping"
          else
            echo "ðŸš€ Publishing $PACKAGE_NAME@$VERSION..."
            # Publish with public access using OIDC (provenance)
            # Note: OIDC requires --provenance
            npm publish --access public --provenance
          fi