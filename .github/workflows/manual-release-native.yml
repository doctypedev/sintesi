name: Release Native Packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g. 0.1.0)'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

jobs:
    release-native:
        name: Release Native (${{ matrix.settings.platform }}-${{ matrix.settings.arch }})
        runs-on: ${{ matrix.settings.host }}
        strategy:
            fail-fast: false
            matrix:
                settings:
                    - host: macos-latest
                      target: aarch64-apple-darwin
                      platform: darwin
                      arch: arm64
                      npm_dir: darwin-arm64
                    - host: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                      platform: linux
                      arch: x64
                      npm_dir: linux-x64-gnu
                    - host: windows-latest
                      target: x86_64-pc-windows-msvc
                      platform: win32
                      arch: x64
                      npm_dir: win32-x64-msvc

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: pnpm/action-setup@v3
              with:
                  version: 10

            - uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'
                  registry-url: 'https://registry.npmjs.org/'

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.settings.target }}

            - name: Update npm
              run: npm install -g npm@latest

            - name: Pull latest changes
              run: git pull origin main

            - name: Install dependencies
              run: pnpm install

            - name: Set version for native package
              shell: bash
              run: |
                  set -e
                  NPM_PACKAGE_DIR="crates/core/npm/${{ matrix.settings.npm_dir }}"
                  
                  echo "â„¹ï¸ Setting version to ${{ inputs.version }} in $NPM_PACKAGE_DIR"
                  
                  if [ ! -d "$NPM_PACKAGE_DIR" ]; then
                    echo "âŒ ERROR: Directory does not exist: $NPM_PACKAGE_DIR"
                    exit 1
                  fi
                  
                  cd "$NPM_PACKAGE_DIR"
                  
                  if [ ! -f "package.json" ]; then
                    echo "âŒ ERROR: package.json not found in $NPM_PACKAGE_DIR"
                    exit 1
                  fi
                  
                  npm version ${{ inputs.version }} --no-git-tag-version --allow-same-version || {
                    echo "âŒ ERROR: Failed to update version in package.json"
                    exit 1
                  }
                  
                  echo "âœ… Version updated successfully"

            - name: Build and Publish Native Package
              shell: bash
              env:
                  CARGO_BUILD_TARGET: ${{ matrix.settings.target }}
              run: |
                  set -e
                  
                  # ============ BUILD PHASE ============
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo "ğŸ—ï¸  BUILDING NATIVE PACKAGE"
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  
                  cd crates/core
                  echo "â„¹ï¸ Installing dependencies in crates/core..."
                  pnpm install || {
                    echo "âŒ ERROR: Failed to install dependencies"
                    exit 1
                  }
                  
                  echo "â„¹ï¸ Building Rust binary for ${{ matrix.settings.target }}..."
                  pnpm run build || {
                    echo "âŒ ERROR: Failed to build Rust binary"
                    exit 1
                  }
                  
                  echo "âœ… Build completed successfully"
                  
                  # ============ PREPARE PHASE ============
                  echo ""
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo "ğŸ“¦ PREPARING NATIVE PACKAGE"
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  
                  NODE_BINARY_NAME="sintesi-core.${{ matrix.settings.npm_dir }}.node"
                  NPM_PACKAGE_DIR="npm/${{ matrix.settings.npm_dir }}"
                  
                  echo "â„¹ï¸ Expected binary name: $NODE_BINARY_NAME"
                  echo "â„¹ï¸ Target npm directory: $NPM_PACKAGE_DIR"
                  
                  # Ensure directory exists
                  mkdir -p "$NPM_PACKAGE_DIR" || {
                    echo "âŒ ERROR: Failed to create npm package directory"
                    exit 1
                  }
                  
                  if [ ! -f "$NODE_BINARY_NAME" ]; then
                    echo "âŒ ERROR: Binary not found at: $NODE_BINARY_NAME"
                    echo "â„¹ï¸ Files in current directory:"
                    ls -la *.node 2>/dev/null || echo "  (no .node files found)"
                    exit 1
                  fi
                  
                  echo "â„¹ï¸ Copying binary to npm package..."
                  cp "$NODE_BINARY_NAME" "$NPM_PACKAGE_DIR/$NODE_BINARY_NAME" || {
                    echo "âŒ ERROR: Failed to copy binary file"
                    exit 1
                  }
                  
                  echo "âœ… Binary copied successfully"
                  
                  # ============ VERSION CHECK PHASE ============
                  echo ""
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo "ğŸ” CHECKING VERSION INFORMATION"
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  
                  cd "$NPM_PACKAGE_DIR"
                  echo "â„¹ï¸ Current working directory: $(pwd)"
                  
                  if [ ! -f "package.json" ]; then
                    echo "âŒ ERROR: package.json not found in npm package directory"
                    exit 1
                  fi
                  
                  # Extract version with error handling
                  LOCAL_VERSION=$(node -p "require('./package.json').version" 2>/dev/null) || {
                    echo "âŒ ERROR: Failed to extract version from package.json"
                    exit 1
                  }
                  
                  if [ -z "$LOCAL_VERSION" ]; then
                    echo "âŒ ERROR: Version is empty in package.json"
                    exit 1
                  fi
                  
                  PACKAGE_NAME="@sintesi/core-${{ matrix.settings.npm_dir }}"
                  echo "â„¹ï¸ Package name: $PACKAGE_NAME"
                  echo "â„¹ï¸ Local version: $LOCAL_VERSION"
                  
                  # ============ REGISTRY QUERY WITH RETRY ============
                  echo ""
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo "ğŸŒ QUERYING NPM REGISTRY"
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  
                  REGISTRY_QUERY_ATTEMPTS=0
                  MAX_RETRY_ATTEMPTS=3
                  RETRY_DELAY=2
                  PUBLISHED_VERSION=""
                  REGISTRY_QUERY_SUCCESS=false
                  
                  while [ $REGISTRY_QUERY_ATTEMPTS -lt $MAX_RETRY_ATTEMPTS ]; do
                    REGISTRY_QUERY_ATTEMPTS=$((REGISTRY_QUERY_ATTEMPTS + 1))
                    echo "â„¹ï¸ Registry query attempt $REGISTRY_QUERY_ATTEMPTS of $MAX_RETRY_ATTEMPTS..."
                    
                    # Use 10-second timeout to prevent hangs
                    if timeout 10 npm view "$PACKAGE_NAME" version 2>/dev/null | read -r PUBLISHED_VERSION_OUTPUT; then
                      PUBLISHED_VERSION="$PUBLISHED_VERSION_OUTPUT"
                      REGISTRY_QUERY_SUCCESS=true
                      echo "âœ… Registry query successful"
                      echo "â„¹ï¸ Published version: ${PUBLISHED_VERSION:-not found}"
                      break
                    else
                      QUERY_EXIT_CODE=$?
                      if [ $QUERY_EXIT_CODE -eq 124 ]; then
                        echo "âš ï¸  Registry query timed out (attempt $REGISTRY_QUERY_ATTEMPTS/$MAX_RETRY_ATTEMPTS)"
                      else
                        echo "âš ï¸  Registry query failed with exit code $QUERY_EXIT_CODE (attempt $REGISTRY_QUERY_ATTEMPTS/$MAX_RETRY_ATTEMPTS)"
                      fi
                      
                      if [ $REGISTRY_QUERY_ATTEMPTS -lt $MAX_RETRY_ATTEMPTS ]; then
                        echo "â„¹ï¸ Waiting ${RETRY_DELAY}s before retry..."
                        sleep $RETRY_DELAY
                      fi
                    fi
                  done
                  
                  # ============ VERSION COMPARISON & PUBLISH DECISION ============
                  echo ""
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo "ğŸ“‹ DETERMINING PUBLISH ACTION"
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  
                  if [ "$REGISTRY_QUERY_SUCCESS" = false ]; then
                    echo "âš ï¸  Registry query failed after $MAX_RETRY_ATTEMPTS attempts"
                    echo "â„¹ï¸ This may indicate transient network issues"
                    echo "â„¹ï¸ Attempting publish assuming version is new..."
                    SHOULD_PUBLISH=true
                  elif [ -z "$PUBLISHED_VERSION" ]; then
                    echo "âœ… Version not found in registry (new release)"
                    SHOULD_PUBLISH=true
                  elif [ "$LOCAL_VERSION" = "$PUBLISHED_VERSION" ]; then
                    echo "â„¹ï¸ Version match detected"
                    echo "  Local version: $LOCAL_VERSION"
                    echo "  Published version: $PUBLISHED_VERSION"
                    echo "ğŸ“¦ This version is already published, skipping"
                    SHOULD_PUBLISH=false
                  else
                    echo "âš ï¸  Version mismatch detected"
                    echo "  Local version: $LOCAL_VERSION"
                    echo "  Published version: $PUBLISHED_VERSION"
                    echo "ğŸš€ Publishing new version..."
                    SHOULD_PUBLISH=true
                  fi
                  
                  # ============ PUBLISH PHASE ============
                  echo ""
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo "ğŸš€ PUBLISHING TO NPM REGISTRY"
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  
                  if [ "$SHOULD_PUBLISH" = true ]; then
                    echo "â„¹ï¸ Publishing $PACKAGE_NAME@$LOCAL_VERSION..."
                    echo "â„¹ï¸ Access level: public"
                    echo "â„¹ï¸ Provenance: enabled"
                    
                    npm publish --access public --provenance || {
                      echo "âŒ ERROR: npm publish failed"
                      exit 1
                    }
                    
                    echo "âœ… Package published successfully!"
                  else
                    echo "â­ï¸  Skipping publish (version already published)"
                  fi
                  
                  echo ""
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo "âœ… WORKFLOW COMPLETED SUCCESSFULLY"
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
