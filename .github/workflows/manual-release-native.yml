name: Release Native Packages

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  release-native:
    name: Release Native (${{ matrix.settings.platform }}-${{ matrix.settings.arch }})
    runs-on: ${{ matrix.settings.host }}
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: macos-latest
            target: aarch64-apple-darwin
            platform: darwin
            arch: arm64

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v3
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org/'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.target }}

      - name: Update npm
        run: npm install -g npm@latest

      - name: Pull latest changes
        run: git pull origin main

      - name: Install dependencies
        run: pnpm install

      - name: Sync version to native packages
        run: node crates/core/scripts/sync-version.js

      - name: Build and Publish Native Package
        env:
          CARGO_BUILD_TARGET: ${{ matrix.settings.target }}
        run: |
          # Build Rust binary
          cd crates/core
          pnpm install
          pnpm run build
          
          # Copy binary to npm package location
          NODE_BINARY_NAME="doctype-core.${{ matrix.settings.platform }}-${{ matrix.settings.arch }}.node"
          NPM_PACKAGE_DIR="npm/${{ matrix.settings.platform }}-${{ matrix.settings.arch }}"
          
          # Ensure directory exists
          mkdir -p "$NPM_PACKAGE_DIR"
          
          cp "$NODE_BINARY_NAME" "$NPM_PACKAGE_DIR/$NODE_BINARY_NAME"
          
          # Publish
          cd "$NPM_PACKAGE_DIR"
          echo "ðŸ“¦ Publishing native package from $(pwd)"
          
          # Check if version exists
          PACKAGE_NAME="@doctypedev/core-${{ matrix.settings.platform }}-${{ matrix.settings.arch }}"
          VERSION=$(node -p "require('./package.json').version")
          PUBLISHED_VERSION=$(npm view $PACKAGE_NAME version 2>/dev/null || echo "")

          if [ "$VERSION" = "$PUBLISHED_VERSION" ]; then
            echo "ðŸ“¦ Version $VERSION already published, skipping"
          else
            echo "ðŸš€ Publishing $PACKAGE_NAME@$VERSION..."
            # Publish with public access using OIDC (provenance)
            # Note: OIDC requires --provenance
            npm publish --access public --provenance
          fi
