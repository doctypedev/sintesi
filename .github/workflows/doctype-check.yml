name: Doctype - Documentation Drift Detection

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch: # Allow manual trigger

jobs:
  doctype-check:
    name: Check Documentation Drift
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run Doctype Check
        run: npx doctype check --verbose
        continue-on-error: false # Fail the workflow if drift detected

      - name: Comment on PR (if drift detected)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ö†Ô∏è Documentation Drift Detected

            The code signatures have changed but the documentation hasn't been updated.

            **Action Required:**
            1. Run \`npx doctype fix\` locally to update documentation
            2. Review the generated content
            3. Update manually if needed (Phase 3 uses placeholders)
            4. Commit the updated documentation

            **Phase 4 Preview:** In the future, this will be automated with AI-generated content!

            ---
            *Generated by [Doctype](https://github.com/alessiopelliccione/doctype) ü§ñ*
            `
            })

  doctype-fix-preview:
    name: Preview Documentation Fixes (Dry Run)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Preview Doctype Fixes
        run: npx doctype fix --dry-run --verbose
        continue-on-error: true # Don't fail, just show preview

      - name: Comment Fix Preview on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üìã Doctype Fix Preview

            This is a dry-run showing what \`npx doctype fix\` would do.

            **To apply these fixes:**
            \`\`\`bash
            npx doctype fix
            git add docs/API.md doctype-map.json
            git commit -m "docs: update documentation via Doctype"
            git push
            \`\`\`

            **Note:** Phase 3 generates placeholder content. Phase 4 will use AI for smart documentation.

            ---
            *Generated by [Doctype](https://github.com/alessiopelliccione/doctype) ü§ñ*
            `
            })
